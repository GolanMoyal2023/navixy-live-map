<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Navixy Live Map</title>
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
      crossorigin=""
    />
    <style>
      html,
      body {
        height: 100%;
        margin: 0;
      }

      #map {
        height: 100%;
        width: 100%;
      }

      .map-overlay {
        position: absolute;
        top: 12px;
        left: 12px;
        background: rgba(17, 24, 39, 0.85);
        color: #ffffff;
        padding: 8px 12px;
        border-radius: 8px;
        font-family: "Segoe UI", Arial, sans-serif;
        font-size: 12px;
        z-index: 1000;
      }
    </style>
  </head>
  <body>
    <div id="map"></div>
    <div class="map-overlay" id="mapStatus">Loading...</div>

    <script
      src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
      integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
      crossorigin=""
    ></script>
    <script>
      const LIVE_API_URL = "https://rolls-connect-round-definitions.trycloudflare.com/data";
      const POLL_INTERVAL_MS = 2000;
      const map = L.map("map").setView([32.004, 34.876], 13);
      const layer = L.layerGroup().addTo(map);

      const osmStreets = L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 19,
        attribution: "&copy; OpenStreetMap contributors",
      }).addTo(map);
      const osmStandard = L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 19,
        attribution: "&copy; OpenStreetMap contributors",
      });
      const esriSat = L.tileLayer(
        "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",
        {
          maxZoom: 19,
          attribution: "Tiles &copy; Esri",
        }
      );
      L.control
        .layers(
          {
            "OSM streets": osmStreets,
            OSM: osmStandard,
            "Satellite (Esri)": esriSat,
          },
          {},
          { position: "topright" }
        )
        .addTo(map);

      const markers = {};
      let fitted = false;
      let activePopupId = null;
      let activePopupUntil = null;
      const iconCache = new Map();

      function iconPathForRow(row) {
        const label = String(row.label || "").toLowerCase();
        const group = String(row.group_name || "").toLowerCase();
        const name = `${label} ${group}`;
        if (label.includes("5032")) {
          return "Pictures/towing_barless_transparent.png";
        }
        if (label.includes("6074")) {
          return "Pictures/Champ70_transparent.png";
        }
        if (name.includes("towing") || name.includes("tow") || name.includes("גוררים")) {
          return "Pictures/TowBar.png";
        }
        if (name.includes("loader") || name.includes("מטענים")) {
          return "Pictures/Loader.png";
        }
        if (name.includes("acu") || name.includes("a/c")) {
          return "Pictures/TLD ACU.png";
        }
        if (name.includes("gpu")) {
          return "Pictures/TLD GPU.png";
        }
        if (name.includes("stair") || name.includes("stairs")) {
          return "Pictures/staires.png";
        }
        if (name.includes("manito")) {
          return "Pictures/Manito.png";
        }
        if (name.includes("tractor") || name.includes("tracktor") || name.includes("trac")) {
          return "Pictures/Tracktor.png";
        }
        return "Pictures/Aviation1.jpg";
      }

      function markerSizeForZoom(zoom) {
        const size = 14 + (zoom - 10) * 3;
        return Math.max(20, Math.min(56, Math.round(size)));
      }

      function markerIcon(path, size) {
        const key = `${path}|${size}`;
        if (!iconCache.has(key)) {
          iconCache.set(
            key,
            L.icon({
              iconUrl: encodeURI(path),
              iconSize: [size, size],
              iconAnchor: [size / 2, size / 2],
              popupAnchor: [0, -size / 2],
            })
          );
        }
        return iconCache.get(key);
      }

      function updateMarkerIcons() {
        const size = markerSizeForZoom(map.getZoom());
        Object.values(markers).forEach((marker) => {
          const iconPath = marker.options.iconPath || "Pictures/Aviation1.jpg";
          marker.setIcon(markerIcon(iconPath, size));
        });
      }

      map.on("zoomend", updateMarkerIcons);

      function statusLabel(row) {
        return row.movement_status || row.connection_status || "unknown";
      }

      function popupHtml(row) {
        const label = row.label || row.tracker_id || "tracker";
        const lat = row.lat;
        const lng = row.lng;
        const status = statusLabel(row);
        const base = `<strong>${label}</strong><br/>${status}<br/>${lat}, ${lng}`;
        const extra = [];
        if (label.includes("6074")) {
          extra.push(`Engine_Temp: ${row.Engine_Temp ?? "--"}`);
          extra.push(`Engine_O.P: ${row["Engine_O.P"] ?? "--"}`);
          extra.push(`Fuel: ${row.Fuel ?? "--"}`);
          extra.push(`Engine Hours: ${row.engine_hours ?? "--"}`);
          extra.push(`Odometer: ${row.odometer ?? "--"}`);
        }
        if (label.includes("5032")) {
          extra.push(`Fuel_level: ${row.Fuel_level ?? "--"}`);
          extra.push(`Engine RPM: ${row.engine_rpm ?? "--"}`);
          extra.push(`Engine Hours: ${row.engine_hours_total ?? row.engine_hours ?? "--"}`);
          extra.push(`Next Service: ${row.next_service_hours ?? "--"}`);
          extra.push(`Odometer: ${row.odometer ?? "--"}`);
        }
        return `${base}${extra.length ? "<br/>" + extra.join("<br/>") : ""}`;
      }

      function updateMarkers(rows) {
        layer.clearLayers();
        const bounds = [];
        Object.keys(markers).forEach((key) => delete markers[key]);
        rows.forEach((row) => {
          const lat = Number(row.lat);
          const lng = Number(row.lng);
          if (!Number.isFinite(lat) || !Number.isFinite(lng)) {
            return;
          }
          const status = row.connection_status || "unknown";
          const label = row.label || row.tracker_id || "tracker";
          const id = row.tracker_id || label;
          const iconPath = iconPathForRow(row);
          const size = markerSizeForZoom(map.getZoom());
          const marker = L.marker([lat, lng], {
            icon: markerIcon(iconPath, size),
            iconPath,
          })
            .bindPopup(popupHtml(row))
            .bindTooltip(label, { permanent: true, direction: "top", offset: [0, -12] });
          marker.off("click", marker._openPopup);
          marker.on("click", () => {
            Object.values(markers).forEach((m) => m.closePopup());
            marker.openPopup();
            activePopupId = id;
            activePopupUntil = Date.now() + 10000;
          });
          marker.on("popupclose", () => {
            if (activePopupId === id) {
              activePopupId = null;
              activePopupUntil = null;
            }
          });
          markers[id] = marker;
          marker.addTo(layer);
          if (!String(label).toLowerCase().includes("skoda")) {
            bounds.push([lat, lng]);
          }
        });

        const statusEl = document.getElementById("mapStatus");
        if (statusEl) {
          statusEl.textContent = `Trackers: ${rows.length} | Markers: ${bounds.length}`;
        }

        if (!fitted) {
          if (bounds.length === 1) {
            map.setView(bounds[0], 15);
          } else {
            map.fitBounds(bounds, { padding: [20, 20] });
          }
          fitted = true;
        }
        if (activePopupId && markers[activePopupId]) {
          if (activePopupUntil && Date.now() <= activePopupUntil) {
            markers[activePopupId].openPopup();
          } else {
            activePopupId = null;
            activePopupUntil = null;
          }
        }
      }

      async function loadData() {
        try {
          const response = await fetch(LIVE_API_URL);
          if (!response.ok) {
            throw new Error("fetch failed");
          }
          const payload = await response.json();
          updateMarkers(payload.rows || []);
        } catch (error) {
          const statusEl = document.getElementById("mapStatus");
          if (statusEl) {
            statusEl.textContent = "Failed to load live data.";
          }
        }
      }

      loadData();
      setInterval(loadData, POLL_INTERVAL_MS);
    </script>
  </body>
</html>
